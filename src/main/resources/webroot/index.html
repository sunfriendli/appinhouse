<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>加勒比海盗企业内部发布渠道</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="shortcut icon" href="img/favicon_16.ico"/>
    <link rel="bookmark" href="img/favicon_16.ico"/>
    <link rel="stylesheet" href="css/site.min.css">
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/sweetalert.css">
    <link rel="stylesheet" href="css/modal.css">

    <script type="text/javascript" src="js/site.min.js"></script>
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/sweetalert.min.js"></script>
    <script type="text/javascript" src="js/jquery.validate.min.js"></script>

    <style type="text/css">
        #top_bar_bg{
            width: 100%;
            height: 100%;
            background-image:url("/img/top-bg.jpg");
            background-size: 100%;
        }
        .row{
            margin-left:0;
        }
    </style>

</head>

<body class="mini-navbar no-skin-config full-height-layout cbp-spmenu-push">
<nav role="navigation">
    <div class="row" id="top_bar_bg">
        <div class="col-xs-12" style="padding-left:40px;padding-top:4px;height: 50px"></div>
    </div>
</nav>
<!--header-->
<div class="container-fluid">
    <!--documents-->
    <div id="page-wrapper" class="gray-bg">
        <div id="main_container" class="col-xs-12 col-sm-12 full-height border-right-green no-padding">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="pull-right">
                        <button style="padding: 15px;" type="button" class="btn btn-w-m btn-primary" onclick="onCreateApp()">创建应用
                        </button>
                    </div>
                    <h4 class="text-navy"><i class="fa fa-info-circle"></i> 项目列表</h4>
                </div>
                <div class="content-row-typography-my">
                    <h4>
                        <i class="fa fa-warning"></i><span> 本发布渠道的目的仅限内部测试用途,不作为对外产品发布.</span>
                    </h4>
                </div>
                <div class="content-row-typography-my">
                    <h4>
                        <i class="fa fa-warning"></i><span> 本服务提供客户端下载功能。提供给北京西山居,深圳西山居等多个地方.</span>
                    </h4>
                </div>
                <div class="panel-body ibox-content profile-content">
                    <table role="presentation" class="table table-striped">
                        <thead>
                        <tr>
                            <th width="25%"><h5>名称</h5></th>
                            <th width="25%"><h5>描述</h5></th>
                            <th width="25%"><h5>ID</h5></th>
                            <th width="25%"><h5>#</h5></th>
                        </tr>
                        </thead>
                        <tbody id="list_body"></tbody>
                    </table>
                    <div class="hidden">
                        <input type="text" id="page" value="0">
                    </div>
                </div>
                <!-- panel body -->
            </div>
        </div><!-- content -->
        <div id="modal_content">

        </div>
    </div>
</div>

</body>

</html>
<script type="text/javascript">

    var app_url = "http://127.0.0.1:8081/api/apps/";

    $(function () {
        reqAppList();
    });

    function reqAppList(page) {
        var suffix = "";
        if (page) {
            suffix = "?last_key=" + $('#page').val()
        }
        var url = app_url + suffix;
        $.ajax({
            type: 'GET',
            url: url,
            dateType: "json",
            success: function (data) {
                $('#list_body').empty();

                $.each(data.data.list, function (index, item) {
                        var appname = item.id;
                        if (item.alias) {
                            appname = item.alias
                        }
                        var modifyButton = $('<button/>')
                            .addClass('btn btn-info')
                            .text('修改')
                            .on('click', function () {
                                onModifyApp(item.id)
                            });
                        var deleteButton = $('<button/>')
                            .addClass('btn btn-danger')
                            .text('删除')
                            .on('click', function () {
                                onDeleteApp(item.id)
                            });
                        var row =
                            $(
                                '<tr>' +
                                '<td width="25%"><h6><a href="index_re.html?app=' + item.id + '" >' + appname + '</a></h6></td>' +
                                '<td width="25%"><h6>' + item.desc + '</h6></td>' +
                                '<td width="25%"><h6>' + item.id + '</h6></td>' +
                                '</tr>'
                            );
                        row.append($('<td width="25%" />').append(modifyButton).append(deleteButton));
                        $('#list_body').append(row);
                    });
            }
        });
    }

    function onCreateApp() {
        $.get("html/appinfo.html",function (data) {
            $("#modal_content").html(data);
            $("#app_owner").val("");
            $("#app_modal_title").text("创建应用");
            $('#app_modal').modal({
                show: true
            });
        })
    }

    function requestCreateApp() {
        var url = app_url;
        $.ajax({
            type: "POST",
            url: url,
            data: JSON.stringify(formData2Json("app_create_form")),
            dataType: "text",
            statusCode: {
                201: function (data, textStatus, jqXHR) {
                    show_success("成功创建应用", function () {
                        $('#app_modal').modal("hide");
                        reqAppList();
                    })
                }
            },
            error: function (data) {
                show_error(data.responseJSON.message);
            }
        });
    }

    function onModifyApp(appID) {
        var url = app_url + appID;
        $.ajax({
            type: "GET",
            url: url,
            dateType: "json",
            success: function (result) {
                //request app info html
                $.get("html/appinfo.html", function (data) {
                    $("#modal_content").html(data);
                    $("#app_owner").val(appID);
                    $("#app_modal_title").text("修改应用");
                    $("#input_app_id").val(result.data.id);
                    $("#input_app_id").attr("readonly",true);
                    $("#input_app_desc").val(result.data.desc);
                    $("#input_app_alias").val(result.data.alias);
                    $('#app_modal').modal({
                        show: true
                    });
                })
            }
        });
    }

    function requestModifyApp(appID) {
        var url = app_url + appID;
        $.ajax({
            type: "PUT",
            url: url,
            data: JSON.stringify(formData2Json("app_create_form")),
            dataType: "json",
            success: function () {
                show_success("修改成功", function () {
                    $('#app_modal').modal("hide");
                    reqAppList();
                })
            },
            error: function (data) {
                show_error(data.responseJSON.message);
            }
        });
    }

    function onDeleteApp(appID) {
        swal({
            title: "执行删除操作",
            text: "确定要删除选中内容?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确认删除!",
            closeOnConfirm: false

        }, function () {
            var url = app_url + appID;
            $.ajax({
                type: 'DELETE',
                url: url,
                dateType: "json",
                success: function (data) {
                    show_success("删除成功",function () {
                        reqAppList();
                    })
                }
            });
        });
    }

</script>
