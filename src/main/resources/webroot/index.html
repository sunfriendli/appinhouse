<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>加勒比海盗企业内部发布渠道</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="/img/favicon_16.ico"/>
    <link rel="bookmark" href="/img/favicon_16.ico"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/fonts/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/plugins/alert/sweetalert.css">
    <link rel="stylesheet" href="/css/plugins/toastr/toastr.min.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/style.css">

    <style type="text/css">
        body.stop-scrolling {
            height: auto !important;
            overflow: visible !important;
        }
    </style>
</head>

<body class="top-navigation pace-done">

<div id="wrapper">
    <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
            <nav class="navbar navbar-static-top white-bg" role="navigation">
                <div class="navbar-header">
                    <a href="#" class="navbar-brand">西山居</a>
                </div>
                <div class="navbar-collapse collapse" id="navbar">
                    <ul class="nav navbar-nav">
                        <li class="active">
                            <a aria-expanded="false" role="button" href="#"> 主页</a>
                        </li>

                    </ul>
                </div>
            </nav>
        </div>
        <div class="row">
            <div class="wrapper wrapper-content">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="pull-right">
                            <button type="button" class="btn btn-w-m btn-primary" onclick="onCreateApp()"><i
                                    class="fa fa-plus"></i>创建应用
                            </button>
                        </div>
                        <h3 class="text-navy"><i class="fa fa-info-circle"></i> 项目列表</h3>
                    </div>
                    <div class="panel-body ibox-content">
                        <table role="presentation" class="table table-striped">
                            <thead>
                            <tr>
                                <th width="25%"><h3 class="font-bold no-margins">名称</h3></th>
                                <th width="25%"><h3 class="font-bold no-margins">描述</h3></th>
                                <th width="25%"><h3 class="font-bold no-margins">ID</h3></th>
                                <th width="25%"><h3 class="font-bold no-margins">#</h3></th>
                            </tr>
                            </thead>
                            <tbody id="list_body"></tbody>
                        </table>
                    </div>
                    <!-- panel body -->
                </div>
            </div><!-- content -->
        </div>
        <div class="footer">
            <div>
                <strong>Copyright</strong> 西山居 Company © 2019-2020
            </div>
        </div>
    </div>
    <div id="modal_content">

    </div>
</div>

<!-- Mainly scripts -->
<script type="text/javascript" src="/js/jquery-2.1.1.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script type="text/javascript" src="/js/plugins/validate/jquery.validate.min.js"></script>
<script type="text/javascript" src="/js/plugins/alert/sweetalert.min.js"></script>
<script type="text/javascript" src="/js/plugins/toastr/toastr.min.js"></script>
<script type="text/javascript" src="/js/appinhouse.js"></script>
<script type="text/javascript" src="/js/utils.js"></script>

<script type="text/javascript">
    var scrollLoad = false;
    var last_key = "";
    $(document).ready(function () {

        $(window).scroll(function () {
            if (scrollLoad && $(window).scrollTop() >= $(document).height() - $(window).height()) {
                scrollLoad = false;
                reqAppList(last_key);
                console.log("load more");
            }
        });

        setTimeout(function () {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                showMethod: 'slideDown',
                timeOut: 3000
            };
            toastr.success('Welcome to AppInHouse', '西山居');
        }, 1500);

        reqAppList();
    });

    function reqAppList(page) {
        var suffix = page ? ("?last_key=" + page) : "";
        $.ajax({
            type: 'GET',
            url: toRestAPI('/api/apps', suffix),
            dateType: "json",
            success: function (data) {

                $.each(data.data.list, function (index, item) {
                    var appname = item.id;
                    if (item.alias) {
                        appname = item.alias
                    }
                    var modifyButton = $('<button/>')
                        .addClass('btn btn-info')
                        .text('修改')
                        .on('click', function () {
                            onModifyApp(item.id)
                        });
                    var deleteButton = $('<button/>')
                        .addClass('btn btn-danger')
                        .text('删除')
                        .on('click', function () {
                            onDeleteApp(item.id)
                        });

                    var row =
                        $(
                            '<tr>' +
                            '<td width="25%"><h3 class="font-bold no-margins" ><a class="text-info" href=' + toRestAPI('/version', item.id) + ' >' + appname + '</a>' +
                            '<i class="fa fa-hand-o-left fa"></i></h3></td>' +
                            '<td width="25%"><h3 class="font-bold no-margins">' + item.desc + '</h3></td>' +
                            '<td width="25%"><h3 class="font-bold no-margins">' + item.id + '</h3></td>' +
                            '</tr>'
                        );
                    row.append($('<td width="25%" />').append(modifyButton).append(deleteButton));
                    $('#list_body').append(row);
                });
                last_key = data.data.last_key;
                scrollLoad = !isEmpty(last_key);
            }
        });
    }

    function onCreateApp() {
        $.get("html/appinfo.html", function (data) {
            $("#modal_content").html(data);
            $("#app_owner").val("");
            $("#app_modal_title").text("创建应用");
            $('#app_modal').modal({
                show: true
            });
        })
    }

    function requestCreateApp() {
        $.ajax({
            type: "POST",
            url: toRestAPI('/api/apps'),
            data: JSON.stringify(formData2Json("app_create_form")),
            dataType: "text",
            statusCode: {
                201: function (data, textStatus, jqXHR) {
                    showSuccess("成功创建应用", function () {
                        $('#app_modal').modal("hide");
                        reqAppList();
                    })
                }
            },
            error: function (data) {
                console.log(data);
                showError(data.responseText);
            }
        });
    }

    function onModifyApp(appID) {
        $.ajax({
            type: "GET",
            url: toRestAPI('/api/apps', appID),
            dateType: "json",
            success: function (result) {
                $.get("html/appinfo.html", function (data) {
                    $("#modal_content").html(data);
                    $("#app_owner").val(appID);
                    $("#app_modal_title").text("修改应用");
                    $("#input_app_id").val(result.data.id);
                    $("#input_app_id").attr("readonly", true);
                    $("#input_app_desc").val(result.data.desc);
                    $("#input_app_alias").val(result.data.alias);
                    $('#app_modal').modal({
                        show: true
                    });
                })
            }
        });
    }

    function requestModifyApp(appID) {
        $.ajax({
            type: "PUT",
            url: toRestAPI('/api/apps', appID),
            data: JSON.stringify(formData2Json("app_create_form")),
            dataType: "json",
            success: function () {
                showSuccess("修改成功", function () {
                    $('#app_modal').modal("hide");
                    reqAppList();
                })
            },
            error: function (data) {
                showError(data.responseJSON.message);
            }
        });
    }

    function onDeleteApp(appID) {
        swal({
            title: "执行删除操作",
            text: "确定要删除选中内容?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确认删除!",
            closeOnConfirm: false

        }, function () {
            $.ajax({
                type: 'DELETE',
                url: toRestAPI('/api/apps', appID),
                dateType: "json",
                success: function (data) {
                    showSuccess("删除成功", function () {
                        reqAppList();
                    })
                }
            });
        });
    }
</script>

</body>
</html>
